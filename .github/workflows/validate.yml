name: Validate manifest and build integrations

on: push

jobs:
  validate-manifest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "24"

      - name: Validate manifest.json against schema
        run: npx ajv-cli validate -s manifest-schema.json -d manifest.json

  list-integrations:
    runs-on: ubuntu-latest
    outputs:
      integrations: ${{ steps.list-integrations.outputs.integrations }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: List integrations in manifest.json
        id: list-integrations
        run: |
          integrations=$(jq -cr '[.[].directory]' ./manifest.json)
          echo "integrations=$integrations" >> "$GITHUB_OUTPUT"

  build-integrations:
    runs-on: ubuntu-latest
    needs: [validate-manifest, list-integrations]
    strategy:
      matrix:
        integration: ${{ fromJson(needs.list-integrations.outputs.integrations) }}
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Verify critical files exist
        run: |
          if [ ! -d "${integration}" ]; then
            echo "Directory ${integration} does not exist"
            exit 1
          fi
          if [ ! -f "${integration}/assets/icon.png" ]; then
            echo "icon.png not found in ${integration}/assets"
            exit 1
          fi
          if [ ! -f "${integration}/README.md" ]; then
            echo "README.md not found in ${integration}/"
            exit 1
          fi
        env:
          integration: ${{ matrix.integration }}

      - name: Build integration
        run: |
          echo "==================================="
          echo " Building ${integration}"
          echo "==================================="
          npm install
          npm run build
        env:
          integration: ${{ matrix.integration }}
        working-directory: ${{ matrix.integration}}
